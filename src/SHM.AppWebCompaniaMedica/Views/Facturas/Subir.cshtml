@model SHM.AppWebCompaniaMedica.Models.SubirFacturaViewModel
@{
    ViewData["Title"] = "Subir Factura";
}

<div class="table-card fade-in">
    <div class="table-header">
        <h3>
            <i class="bi bi-file-earmark-arrow-up"></i>
            Subir Factura - @Model.CodigoProduccion
        </h3>
    </div>
    <div style="padding: 2rem;">
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger" style="border-radius: 12px; margin-bottom: 1.5rem;">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                @TempData["Error"]
            </div>
        }

        <!-- Seccion de Informacion (Solo Lectura) -->
        <div class="mb-4">
            <h6 class="mb-3" style="font-weight: 700; color: var(--primary);">
                <i class="bi bi-info-circle me-2"></i>Informacion de la Produccion
            </h6>
            <div class="row g-3">
                <div class="col-md-6">
                    <div style="padding: 1rem; background: var(--bg-main); border-radius: 12px;">
                        <span style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">Sede</span>
                        <span style="font-weight: 600;">@Model.NombreSede</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div style="padding: 1rem; background: var(--bg-main); border-radius: 12px;">
                        <span style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">Produccion</span>
                        <span style="font-weight: 600; font-family: 'JetBrains Mono', monospace;">@Model.CodigoProduccion</span>
                    </div>
                </div>
                <div class="col-md-12">
                    <div style="padding: 1rem; background: var(--bg-main); border-radius: 12px;">
                        <span style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">Concepto</span>
                        <span style="font-weight: 600;">@(Model.Concepto ?? "-")</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div style="padding: 1rem; background: var(--bg-main); border-radius: 12px;">
                        <span style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">Importe</span>
                        <span style="font-weight: 700; color: var(--accent); font-size: 1.25rem;">S/ @(Model.MtoTotal?.ToString("N2") ?? "0.00")</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div style="padding: 1rem; background: var(--bg-main); border-radius: 12px;">
                        <span style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">Fecha Limite</span>
                        <span style="font-weight: 600; color: var(--danger);">@(Model.FechaLimite?.ToString("dd/MM/yyyy") ?? "-")</span>
                    </div>
                </div>
            </div>
        </div>

        <hr style="margin: 2rem 0; border-color: var(--border);">

        <!-- Seccion de Datos Bancarios -->
        <div class="mb-4">
            <h6 class="mb-3" style="font-weight: 700; color: var(--primary);">
                <i class="bi bi-bank me-2"></i>Datos Bancarios para Pago
            </h6>
            @if (!Model.TieneCuentaBancaria)
            {
                @if (Model.RequiereValidacionCuenta)
                {
                    <div class="alert alert-danger" style="border-radius: 12px; background: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.3);">
                        <i class="bi bi-x-circle-fill me-2"></i>
                        <strong>No puede enviar facturas.</strong> No tiene cuenta bancaria registrada. Por favor contacte al administrador.
                    </div>
                }
                else
                {
                    <div class="alert alert-warning" style="border-radius: 12px; background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3);">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        No tiene cuenta bancaria registrada. Por favor contacte al administrador.
                    </div>
                }
            }
            <div class="row g-3">
                <div class="col-md-3">
                    <div style="padding: 1rem; background: var(--bg-main); border-radius: 12px;">
                        <span style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">Banco</span>
                        <span style="font-weight: 600;">@(Model.NombreBanco ?? "-")</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div style="padding: 1rem; background: var(--bg-main); border-radius: 12px;">
                        <span style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">Cuenta Corriente</span>
                        <span style="font-weight: 600; font-family: 'JetBrains Mono', monospace;">@(Model.CuentaCorriente ?? "-")</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div style="padding: 1rem; background: var(--bg-main); border-radius: 12px;">
                        <span style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">Cuenta CCI</span>
                        <span style="font-weight: 600; font-family: 'JetBrains Mono', monospace;">@(Model.CuentaCci ?? "-")</span>
                    </div>
                </div>
                <div class="col-md-2">
                    <div style="padding: 1rem; background: var(--bg-main); border-radius: 12px;">
                        <span style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">Moneda</span>
                        <span style="font-weight: 600;">@(Model.Moneda ?? "-")</span>
                    </div>
                </div>
            </div>
        </div>

        <hr style="margin: 2rem 0; border-color: var(--border);">

        <!-- Formulario de Datos de la Factura -->
        <form id="uploadForm" asp-controller="Facturas" asp-action="PrepararVistaPrevia" method="post" enctype="multipart/form-data">
            <input type="hidden" id="guidRegistro" name="guidRegistro" value="@Model.GuidRegistro" />

            <h6 class="mb-3" style="font-weight: 700; color: var(--primary);">
                <i class="bi bi-pencil-square me-2"></i>Datos de la Factura
            </h6>

            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label" style="font-weight: 600;">Tipo Comprobante <span style="color: var(--danger);">*</span></label>
                    <select class="form-control" id="tipoComprobante" name="tipoComprobante" required>
                        <option value="">Seleccione...</option>
                        <option value="01">Factura</option>
                        <option value="03">Boleta</option>
                        <option value="02">Recibo por Honorarios</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label" style="font-weight: 600;">Fecha de Emision <span style="color: var(--danger);">*</span></label>
                    <input type="date" class="form-control" id="fechaEmision" name="fechaEmision" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label" style="font-weight: 600;">Serie <span style="color: var(--danger);">*</span></label>
                    <input type="text" class="form-control" id="serie" name="serie" placeholder="Ej: F001" maxlength="4" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label" style="font-weight: 600;">Numero <span style="color: var(--danger);">*</span></label>
                    <input type="text" class="form-control" id="numero" name="numero" placeholder="Ej: 00001234" maxlength="8" required>
                </div>
            </div>

            <hr style="margin: 2rem 0; border-color: var(--border);">

            <!-- Seccion de Archivos -->
            <h6 class="mb-3" style="font-weight: 700; color: var(--primary);">
                <i class="bi bi-file-earmark-arrow-up me-2"></i>Documentos Electronicos
            </h6>

            <div class="row g-3 mb-4">
                <!-- PDF -->
                <div class="col-md-4">
                    <label class="form-label" style="font-weight: 600;">Archivo PDF <span style="color: var(--danger);">*</span></label>
                    <div class="file-upload-area" id="pdfArea" style="border: 2px dashed var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; transition: all 0.3s ease; cursor: pointer; background: var(--bg-main); min-height: 180px; display: flex; flex-direction: column; justify-content: center;">
                        <i class="bi bi-file-earmark-pdf" style="font-size: 2.5rem; color: var(--danger); margin-bottom: 0.75rem;"></i>
                        <p class="mb-1" style="font-weight: 600; font-size: 0.9rem;">Factura PDF</p>
                        <p class="text-muted mb-0" style="font-size: 0.75rem;">Click para seleccionar</p>
                    </div>
                    <input type="file" id="archivoPdf" name="archivoPdf" accept=".pdf" style="display: none;" required>
                    <div id="pdfFileName" class="mt-2" style="display: none; color: var(--accent); font-weight: 600; font-size: 0.85rem;">
                        <i class="bi bi-check-circle-fill me-1"></i>
                        <span id="pdfFileNameText"></span>
                    </div>
                </div>

                <!-- XML -->
                <div class="col-md-4">
                    <label class="form-label" style="font-weight: 600;">Archivo XML <span style="color: var(--danger);">*</span></label>
                    <div class="file-upload-area" id="xmlArea" style="border: 2px dashed var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; transition: all 0.3s ease; cursor: pointer; background: var(--bg-main); min-height: 180px; display: flex; flex-direction: column; justify-content: center;">
                        <i class="bi bi-file-earmark-code" style="font-size: 2.5rem; color: var(--warning); margin-bottom: 0.75rem;"></i>
                        <p class="mb-1" style="font-weight: 600; font-size: 0.9rem;">Factura XML</p>
                        <p class="text-muted mb-0" style="font-size: 0.75rem;">Click para seleccionar</p>
                    </div>
                    <input type="file" id="archivoXml" name="archivoXml" accept=".xml" style="display: none;" required>
                    <div id="xmlFileName" class="mt-2" style="display: none; color: var(--accent); font-weight: 600; font-size: 0.85rem;">
                        <i class="bi bi-check-circle-fill me-1"></i>
                        <span id="xmlFileNameText"></span>
                    </div>
                </div>

                <!-- CDR -->
                <div class="col-md-4">
                    <label class="form-label" style="font-weight: 600;">Archivo CDR <span style="color: var(--danger);">*</span></label>
                    <div class="file-upload-area" id="cdrArea" style="border: 2px dashed var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; transition: all 0.3s ease; cursor: pointer; background: var(--bg-main); min-height: 180px; display: flex; flex-direction: column; justify-content: center;">
                        <i class="bi bi-file-earmark-zip" style="font-size: 2.5rem; color: var(--primary); margin-bottom: 0.75rem;"></i>
                        <p class="mb-1" style="font-weight: 600; font-size: 0.9rem;">Constancia CDR</p>
                        <p class="text-muted mb-0" style="font-size: 0.75rem;">Click para seleccionar</p>
                    </div>
                    <input type="file" id="archivoCdr" name="archivoCdr" accept=".zip,.xml" style="display: none;" required>
                    <div id="cdrFileName" class="mt-2" style="display: none; color: var(--accent); font-weight: 600; font-size: 0.85rem;">
                        <i class="bi bi-check-circle-fill me-1"></i>
                        <span id="cdrFileNameText"></span>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2 mt-4">
                <a asp-controller="Facturas" asp-action="Pendientes" class="btn btn-secondary" style="border-radius: 12px; padding: 0.875rem 2rem;">
                    <i class="bi bi-arrow-left me-2"></i>Cancelar
                </a>
                @if (Model.PuedeSubirFactura)
                {
                    <button type="submit" id="btnVistaPrevia" class="btn-submit flex-grow-1"
                            style="background: var(--accent); color: white; border: none; border-radius: 12px; padding: 0.875rem 2rem; font-weight: 600; transition: all 0.3s ease;">
                        <i class="bi bi-eye-fill me-2"></i>Vista Previa y Enviar
                    </button>
                }
                else
                {
                    <button type="button" disabled class="btn-submit flex-grow-1" style="background: #6c757d; color: white; border: none; border-radius: 12px; padding: 0.875rem 2rem; font-weight: 600; cursor: not-allowed;">
                        <i class="bi bi-lock-fill me-2"></i>No puede enviar factura (Sin cuenta bancaria)
                    </button>
                }
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Referencias DOM
            var form = document.getElementById('uploadForm');
            var btnVistaPrevia = document.getElementById('btnVistaPrevia');
            var pdfInput = document.getElementById('archivoPdf');
            var xmlInput = document.getElementById('archivoXml');
            var cdrInput = document.getElementById('archivoCdr');

            // Click en areas de upload
            document.getElementById('pdfArea').addEventListener('click', function() { pdfInput.click(); });
            document.getElementById('xmlArea').addEventListener('click', function() { xmlInput.click(); });
            document.getElementById('cdrArea').addEventListener('click', function() { cdrInput.click(); });

            // Cambio de archivos
            pdfInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    document.getElementById('pdfFileNameText').textContent = this.files[0].name;
                    document.getElementById('pdfFileName').style.display = 'block';
                    document.getElementById('pdfArea').style.borderColor = 'var(--accent)';
                }
            });

            xmlInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    document.getElementById('xmlFileNameText').textContent = this.files[0].name;
                    document.getElementById('xmlFileName').style.display = 'block';
                    document.getElementById('xmlArea').style.borderColor = 'var(--accent)';
                }
            });

            cdrInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    document.getElementById('cdrFileNameText').textContent = this.files[0].name;
                    document.getElementById('cdrFileName').style.display = 'block';
                    document.getElementById('cdrArea').style.borderColor = 'var(--accent)';
                }
            });

            // Hover en areas de upload
            document.querySelectorAll('.file-upload-area').forEach(function(area) {
                area.addEventListener('mouseenter', function() {
                    if (this.style.borderColor !== 'var(--accent)') {
                        this.style.borderColor = 'var(--primary)';
                        this.style.background = 'rgba(242, 101, 34, 0.05)';
                    }
                });
                area.addEventListener('mouseleave', function() {
                    if (this.style.borderColor !== 'var(--accent)') {
                        this.style.borderColor = 'var(--border)';
                        this.style.background = 'var(--bg-main)';
                    }
                });
            });

            // Validar formulario antes de enviar
            form.addEventListener('submit', function(e) {
                var errores = [];

                if (!document.getElementById('tipoComprobante').value) errores.push('Seleccione el tipo de comprobante');
                if (!document.getElementById('fechaEmision').value) errores.push('Ingrese la fecha de emision');
                if (!document.getElementById('serie').value.trim()) errores.push('Ingrese la serie del comprobante');
                if (!document.getElementById('numero').value.trim()) errores.push('Ingrese el numero del comprobante');
                if (!pdfInput.files[0]) errores.push('Seleccione el archivo PDF');
                if (!xmlInput.files[0]) errores.push('Seleccione el archivo XML');
                if (!cdrInput.files[0]) errores.push('Seleccione el archivo CDR');

                if (errores.length > 0) {
                    e.preventDefault();
                    Swal.fire({
                        icon: 'warning',
                        title: 'Campos Requeridos',
                        html: '<ul style="text-align: left; margin: 0; padding-left: 1.5rem;">' +
                              errores.map(function(err) { return '<li>' + err + '</li>'; }).join('') + '</ul>',
                        confirmButtonText: 'Entendido',
                        confirmButtonColor: '#f26522'
                    });
                    return;
                }

                // Mostrar loading
                if (btnVistaPrevia) {
                    btnVistaPrevia.disabled = true;
                    btnVistaPrevia.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
                }
            });
        });
    </script>
}
