@{
    ViewData["Title"] = "Test - Subir Archivo";
    var tipoAlmacenamiento = ViewBag.TipoAlmacenamiento as string ?? "FILE";
}

<!-- Top Bar -->
<div class="top-bar fade-in">
    <div>
        <h1><i class="bi bi-gear-fill me-2"></i>Prueba de Archivos</h1>
        <p class="text-muted mb-0">Probar subida y descarga de archivos</p>
    </div>
</div>

<!-- Info Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="table-card fade-in">
            <div class="table-header">
                <h3>
                    <i class="bi bi-info-circle-fill"></i>
                    Configuracion Actual
                </h3>
            </div>
            <div style="padding: 1.5rem;">
                <div class="d-flex align-items-center gap-3">
                    <span class="fw-semibold">Tipo de Almacenamiento:</span>
                    @if (tipoAlmacenamiento == "BLOB")
                    {
                        <span class="badge bg-primary" style="font-size: 0.9rem;">
                            <i class="bi bi-database me-1"></i>BLOB (Base de Datos)
                        </span>
                    }
                    else
                    {
                        <span class="badge bg-success" style="font-size: 0.9rem;">
                            <i class="bi bi-folder me-1"></i>FILE (Sistema de Archivos)
                        </span>
                    }
                    <small class="text-muted">(Parametro: SHM_TIPO_ALMACENAMIENTO_ARCHIVO)</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Form -->
<div class="row">
    <div class="col-md-6">
        <div class="table-card fade-in">
            <div class="table-header">
                <h3>
                    <i class="bi bi-cloud-arrow-up-fill"></i>
                    Subir Archivo
                </h3>
            </div>
            <div style="padding: 1.5rem;">
                <form id="formSubirArchivo" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()

                    <div class="mb-3">
                        <label for="archivo" class="form-label fw-semibold">
                            Seleccionar Archivo <span class="text-danger">*</span>
                        </label>
                        <input type="file" class="form-control" id="archivo" name="archivo" required>
                        <div class="form-text">Formatos permitidos: PDF, XML, JPG, PNG, ZIP, DOC, XLS, TXT</div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="btnSubir">
                        <i class="bi bi-upload me-2"></i>Subir Archivo
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Result Panel -->
    <div class="col-md-6">
        <div class="table-card fade-in" id="panelResultado" style="display: none;">
            <div class="table-header">
                <h3>
                    <i class="bi bi-check-circle-fill"></i>
                    Resultado
                </h3>
            </div>
            <div style="padding: 1.5rem;">
                <div id="resultadoContenido">
                    <!-- Resultado se llena dinamicamente -->
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#formSubirArchivo').on('submit', function (e) {
                e.preventDefault();

                const fileInput = $('#archivo')[0];
                if (!fileInput.files || fileInput.files.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Archivo requerido',
                        text: 'Por favor seleccione un archivo para subir',
                        confirmButtonColor: '#f26522'
                    });
                    return;
                }

                const formData = new FormData();
                formData.append('archivo', fileInput.files[0]);
                formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

                // Deshabilitar boton
                $('#btnSubir').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Subiendo...');

                $.ajax({
                    url: '@Url.Action("SubirArchivo", "Test")',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            // Mostrar resultado
                            $('#panelResultado').show();

                            const data = response.data;
                            const tipoAlmacenamientoBadge = data.tipoAlmacenamiento === 'BLOB'
                                ? '<span class="badge bg-primary"><i class="bi bi-database me-1"></i>BLOB</span>'
                                : '<span class="badge bg-success"><i class="bi bi-folder me-1"></i>FILE</span>';

                            $('#resultadoContenido').html(`
                                <div class="alert alert-success mb-3">
                                    <i class="bi bi-check-circle me-2"></i>${response.message}
                                </div>
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td class="fw-semibold" style="width: 40%;">ID Archivo:</td>
                                            <td><code>${data.idArchivo}</code></td>
                                        </tr>
                                        <tr>
                                            <td class="fw-semibold">GUID:</td>
                                            <td><code style="font-size: 0.75rem;">${data.guidRegistro}</code></td>
                                        </tr>
                                        <tr>
                                            <td class="fw-semibold">Nombre Original:</td>
                                            <td>${data.nombreOriginal}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-semibold">Extension:</td>
                                            <td><code>${data.extension}</code></td>
                                        </tr>
                                        <tr>
                                            <td class="fw-semibold">Tamano:</td>
                                            <td>${formatBytes(data.tamano)}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-semibold">Tipo Almacenamiento:</td>
                                            <td>${tipoAlmacenamientoBadge}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-semibold">Fecha Creacion:</td>
                                            <td>${data.fechaCreacion}</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="mt-3">
                                    <a href="@Url.Action("DescargarArchivo", "Test")?guid=${data.guidRegistro}"
                                       class="btn btn-success" target="_blank">
                                        <i class="bi bi-download me-2"></i>Descargar Archivo
                                    </a>
                                    <button type="button" class="btn btn-outline-secondary ms-2" onclick="limpiarFormulario()">
                                        <i class="bi bi-arrow-repeat me-2"></i>Subir Otro
                                    </button>
                                </div>
                            `);

                            // Limpiar input
                            $('#archivo').val('');

                            Swal.fire({
                                icon: 'success',
                                title: 'Archivo subido',
                                text: response.message,
                                confirmButtonColor: '#28a745',
                                timer: 2000,
                                timerProgressBar: true
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: response.message,
                                confirmButtonColor: '#dc3545'
                            });
                        }
                    },
                    error: function (xhr) {
                        console.error('Error:', xhr);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al comunicarse con el servidor',
                            confirmButtonColor: '#dc3545'
                        });
                    },
                    complete: function () {
                        // Habilitar boton
                        $('#btnSubir').prop('disabled', false).html('<i class="bi bi-upload me-2"></i>Subir Archivo');
                    }
                });
            });
        });

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function limpiarFormulario() {
            $('#panelResultado').hide();
            $('#resultadoContenido').html('');
            $('#archivo').val('');
        }
    </script>
}
