@model SHM.AppDomain.DTOs.OrdenPago.OrdenPagoResponseDto
@{
    ViewData["Title"] = "Aprobaci\u00f3n de Orden de Pago";
    var liquidaciones = ViewBag.Liquidaciones as List<SHM.AppDomain.DTOs.OrdenPagoLiquidacion.OrdenPagoLiquidacionResponseDto>
        ?? new List<SHM.AppDomain.DTOs.OrdenPagoLiquidacion.OrdenPagoLiquidacionResponseDto>();
    var aprobaciones = ViewBag.Aprobaciones as List<SHM.AppDomain.DTOs.OrdenPagoAprobacion.OrdenPagoAprobacionResponseDto>
        ?? new List<SHM.AppDomain.DTOs.OrdenPagoAprobacion.OrdenPagoAprobacionResponseDto>();
    var detalleLiquidaciones = ViewBag.DetalleLiquidaciones as List<SHM.AppDomain.DTOs.OrdenPagoLiquidacion.DetalleLiquidacionItemDto>
        ?? new List<SHM.AppDomain.DTOs.OrdenPagoLiquidacion.DetalleLiquidacionItemDto>();
    var estadoBgClass = Model.Estado switch
    {
        "PENDIENTE" => "bg-gradient-secondary",
        "EN_APROBACION" => "bg-gradient-info",
        "APROBADO" => "bg-gradient-success",
        "PAGADO" => "bg-gradient-success",
        "RECHAZADO" => "bg-gradient-danger",
        _ => "bg-gradient-secondary"
    };
    var estadoDisplay = Model.Estado switch
    {
        "PENDIENTE" => "Pendiente",
        "EN_APROBACION" => "En Aprobaci\u00f3n",
        "APROBADO" => "Aprobado",
        "PAGADO" => "Pagado",
        "RECHAZADO" => "Rechazado",
        _ => Model.Estado ?? "-"
    };
}

@section Styles {
    <style>
    </style>
}

<div class="content-wrapper">

    <div class="content-header">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-6">
                    <h1 class="m-0 titulo-formulario">Aprobaci&oacute;n: @(Model.NumeroOrdenPago ?? "-")</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="@Url.Action("Index","OrdenPagoAprobacion")" class="btn btn-secondary py-1">Cerrar</a></li>
                    </ol>
                </div>
            </div>

            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">Corporativo</li>
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "OrdenPagoAprobacion")">Aprobaci&oacute;n de Orden de Pago</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Detalle</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="content">
        <div class="container-fluid">

            <!-- Datos de Orden de Pago -->
            <div class="card card-secondary card-outline">
                <div class="card-header">
                    Datos de Orden de Pago
                </div>

                <div class="card-body">

                    <div class="row mt-1">
                        <div class="col-lg-2 col-md-2 col-sm-12">
                            <label class="adg-label">Orden de Pago</label>
                            <input type="text" class="form-control" readonly value="@(Model.NumeroOrdenPago ?? "-")" disabled />
                        </div>
                        <div class="col-lg-2 col-md-2 col-sm-12">
                            <label class="adg-label">Banco</label>
                            <input type="text" class="form-control" readonly value="@(Model.NombreBanco ?? "-")" disabled />
                        </div>
                        <div class="col-lg-2 col-md-2 col-sm-12">
                            <label class="adg-label">Fecha de Generaci&oacute;n</label>
                            <input type="text" class="form-control" readonly value="@(Model.FechaGeneracion?.ToString("dd/MM/yyyy") ?? "-")" disabled />
                        </div>
                    </div>

                    <div class="row mt-2">
                        <div class="col-lg-2 col-md-2 col-sm-12">
                            <label class="adg-label">N&deg; de Liquidaciones</label>
                            <input type="text" class="form-control" readonly value="@(Model.CantLiquidaciones?.ToString() ?? "-")" disabled />
                        </div>
                        <div class="col-lg-2 col-md-2 col-sm-12">
                            <label class="adg-label">N&deg; de Facturas</label>
                            <input type="text" class="form-control" readonly value="@(Model.CantComprobantes?.ToString() ?? "-")" disabled />
                        </div>
                        <div class="col-lg-2 col-md-2 col-sm-12">
                            <label class="adg-label">Estado de Aprobaci&oacute;n</label>
                            <input type="text" class="form-control @estadoBgClass" readonly value="@estadoDisplay" disabled />
                        </div>
                    </div>

                    <div class="row mt-2">
                        <div class="col-lg-2 col-md-2 col-sm-12">
                            <label class="adg-label">Sub Total (S/.)</label>
                            <input type="text" class="form-control" readonly value="@(Model.MtoSubtotalAcum?.ToString("N2") ?? "--")" disabled />
                        </div>
                        <div class="col-lg-2 col-md-2 col-sm-12">
                            <label class="adg-label">IGV (S/.)</label>
                            <input type="text" class="form-control" readonly value="@(Model.MtoIgvAcum?.ToString("N2") ?? "--")" disabled />
                        </div>
                        <div class="col-lg-2 col-md-2 col-sm-12">
                            <label class="adg-label">Imp. Renta (S/.)</label>
                            <input type="text" class="form-control" readonly value="@(Model.MtoRentaAcum?.ToString("N2") ?? "--")" disabled />
                        </div>
                        <div class="col-lg-2 col-md-2 col-sm-12">
                            <label class="adg-label">Total (S/.)</label>
                            <input type="text" class="form-control" readonly value="@(Model.MtoTotalAcum?.ToString("N2") ?? "--")" disabled />
                        </div>
                    </div>

                </div>

                @if (Model.Estado == "EN_APROBACION")
                {
                    <div class="card-footer">
                        <button type="button" class="btn btn-danger" onclick="rechazarOrden()">
                            <i class="fas fa-times-circle mr-1"></i>Devolver
                        </button>
                        <button type="button" class="btn bg-gradient-success border-success ml-1" onclick="aprobarOrden()">
                            <i class="fas fa-check-circle mr-1"></i>Aprobar
                        </button>
                    </div>
                }

            </div>

            <!-- Detalle de aprobacion -->
            <div class="card card-secondary card-outline">
                <div class="card-header">
                    Detalle de Aprobaci&oacute;n
                </div>

                <div class="card-body">

                    <table class="table table-sm table-bordered mt-1 w-75">
                        <thead class="bg-secondary">
                            <tr class="text-center">
                                <th>#</th>
                                <th>Perfil</th>
                                <th>Estado</th>
                                <th>Nombre</th>
                                <th>Fecha de Aprobaci&oacute;n</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (aprobaciones.Any())
                            {
                                @foreach (var aprob in aprobaciones)
                                {
                                    var estadoAprob = aprob.Estado switch
                                    {
                                        "APROBADO" => "Aprobado",
                                        "RECHAZADO" => "Rechazado",
                                        "PENDIENTE" => "Pendiente",
                                        _ => aprob.Estado ?? "-"
                                    };
                                    var estadoClass = aprob.Estado switch
                                    {
                                        "APROBADO" => "text-success",
                                        "RECHAZADO" => "text-danger",
                                        "PENDIENTE" => "text-warning",
                                        _ => "text-secondary"
                                    };
                                    <tr>
                                        <td class="text-center">@(aprob.Orden?.ToString() ?? "-")</td>
                                        <td>@(aprob.NombrePerfil ?? "-")</td>
                                        <td class="text-center @estadoClass font-weight-bold">@estadoAprob</td>
                                        <td>@(aprob.NombreAprobador ?? "-")</td>
                                        <td>@(aprob.FechaAprobacion?.ToString("dd/MM/yyyy hh:mm tt") ?? "-")</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-3">
                                        No hay aprobaciones registradas
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                </div>

            </div>

            <!-- Liquidaciones asociadas -->
            <div class="card card-secondary card-outline">
                <div class="card-header">
                    Liquidaciones (@liquidaciones.Count)
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped table-hover table-bordered mb-0" style="font-size: 0.85rem;">
                            <thead class="bg-secondary">
                                <tr class="text-center">
                                    <th style="width: 30px;">#</th>
                                    <th>N&deg; Liquidaci&oacute;n</th>
                                    <th>C&oacute;digo</th>
                                    <th>Descripci&oacute;n</th>
                                    <th>Periodo</th>
                                    <th>Banco</th>
                                    <th>Cant. Comprob.</th>
                                    <th class="text-right">Sub Total S/.</th>
                                    <th class="text-right">IGV S/.</th>
                                    <th class="text-right">Renta S/.</th>
                                    <th class="text-right">Total S/.</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (liquidaciones.Any())
                                {
                                    var index = 0;
                                    @foreach (var liq in liquidaciones)
                                    {
                                        index++;
                                        <tr>
                                            <td class="text-center">@index</td>
                                            <td class="text-center">@(liq.NumeroLiquidacion ?? "-")</td>
                                            <td class="text-center">@(liq.CodigoLiquidacion ?? "-")</td>
                                            <td>@(liq.DescripcionLiquidacion ?? "-")</td>
                                            <td class="text-center">@(liq.PeriodoLiquidacion ?? "-")</td>
                                            <td>@(liq.NombreBanco ?? "-")</td>
                                            <td class="text-center">@(liq.CantComprobantes?.ToString() ?? "-")</td>
                                            <td class="text-right">@(liq.MtoSubtotalAcum?.ToString("N2") ?? "--")</td>
                                            <td class="text-right">@(liq.MtoIgvAcum?.ToString("N2") ?? "--")</td>
                                            <td class="text-right">@(liq.MtoRentaAcum?.ToString("N2") ?? "--")</td>
                                            <td class="text-right font-weight-bold">@(liq.MtoTotalAcum?.ToString("N2") ?? "--")</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="11" class="text-center text-muted py-3">
                                            <i class="fas fa-inbox fa-2x mb-2"></i>
                                            <p class="mb-0">No hay liquidaciones asociadas</p>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            @if (liquidaciones.Any())
                            {
                                <tfoot class="bg-light font-weight-bold">
                                    <tr>
                                        <td colspan="7" class="text-right">TOTALES:</td>
                                        <td class="text-right">@(liquidaciones.Sum(l => l.MtoSubtotalAcum ?? 0).ToString("N2"))</td>
                                        <td class="text-right">@(liquidaciones.Sum(l => l.MtoIgvAcum ?? 0).ToString("N2"))</td>
                                        <td class="text-right">@(liquidaciones.Sum(l => l.MtoRentaAcum ?? 0).ToString("N2"))</td>
                                        <td class="text-right">@(liquidaciones.Sum(l => l.MtoTotalAcum ?? 0).ToString("N2"))</td>
                                    </tr>
                                </tfoot>
                            }
                        </table>
                    </div>
                </div>
            </div>

            <!-- Detalle de Liquidaciones asociadas -->
            <div class="card card-secondary card-outline">
                <div class="card-header">
                    Detalle de Liquidaciones (@detalleLiquidaciones.Count)
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped table-hover table-bordered mb-0" style="font-size: 0.85rem;">
                            <thead class="bg-secondary">
                                <tr class="text-center">
                                    <th>C&oacute;digo Liquidaci&oacute;n</th>
                                    <th>Descripci&oacute;n Liquidaci&oacute;n</th>
                                    <th>Tipo de Liquidaci&oacute;n</th>
                                    <th>Periodo Liquidaci&oacute;n</th>
                                    <th>RUC</th>
                                    <th>Tipo Entidad</th>
                                    <th>Raz&oacute;n Social</th>
                                    <th>Banco</th>
                                    <th>Comprobante<br />Factura / RHE</th>
                                    <th class="text-right">Sub Total<br />S/.</th>
                                    <th class="text-right">IGV<br />S/.</th>
                                    <th class="text-right">Imp. Renta<br />S/.</th>
                                    <th class="text-right">Total<br />S/.</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (detalleLiquidaciones.Any())
                                {
                                    @foreach (var det in detalleLiquidaciones)
                                    {
                                        var comprobante = !string.IsNullOrEmpty(det.Serie) && !string.IsNullOrEmpty(det.Numero)
                                            ? $"{det.Serie}-{det.Numero}"
                                            : "-";
                                        <tr>
                                            <td class="text-center">@(det.CodigoLiquidacion ?? "-")</td>
                                            <td>@(det.DescripcionLiquidacion ?? "-")</td>
                                            <td>@(det.TipoLiquidacion ?? "-")</td>
                                            <td class="text-center">@(det.PeriodoLiquidacion ?? "-")</td>
                                            <td class="text-center">@(det.Ruc ?? "-")</td>
                                            <td>@(det.TipoEntidadMedica ?? "-")</td>
                                            <td>@(det.RazonSocial ?? "-")</td>
                                            <td class="text-center">@(det.NombreBanco ?? "-")</td>
                                            <td class="text-center">@comprobante</td>
                                            <td class="text-right">@(det.MtoSubtotal?.ToString("N2") ?? "--")</td>
                                            <td class="text-right">@(det.MtoIgv?.ToString("N2") ?? "--")</td>
                                            <td class="text-right">@(det.MtoRenta?.ToString("N2") ?? "--")</td>
                                            <td class="text-right font-weight-bold">@(det.MtoTotal?.ToString("N2") ?? "--")</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="13" class="text-center text-muted py-3">
                                            <i class="fas fa-inbox fa-2x mb-2"></i>
                                            <p class="mb-0">No hay detalle de liquidaciones</p>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            @if (detalleLiquidaciones.Any())
                            {
                                <tfoot class="bg-light font-weight-bold">
                                    <tr>
                                        <td colspan="9" class="text-right">TOTAL GENERAL:</td>
                                        <td class="text-right">@(detalleLiquidaciones.Sum(d => d.MtoSubtotal ?? 0).ToString("N2"))</td>
                                        <td class="text-right">@(detalleLiquidaciones.Sum(d => d.MtoIgv ?? 0).ToString("N2"))</td>
                                        <td class="text-right">@(detalleLiquidaciones.Sum(d => d.MtoRenta ?? 0).ToString("N2"))</td>
                                        <td class="text-right">@(detalleLiquidaciones.Sum(d => d.MtoTotal ?? 0).ToString("N2"))</td>
                                    </tr>
                                </tfoot>
                            }
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

</div>

@Html.AntiForgeryToken()

<input type="hidden" id="hdnGuidOrdenPago" value="@Model.GuidRegistro" />
<input type="hidden" value="@TempData["APP_RESPONSE"]" id="app-response" />
<input type="hidden" value="@TempData["APP_MESSAGE"]" id="app-message" />

@section Scripts {
    <script type="text/javascript">
        function aprobarOrden() {
            Swal.fire({
                icon: 'question',
                title: 'Aprobar Orden de Pago',
                text: '\u00bfEst\u00e1 seguro que desea aprobar esta orden de pago?',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'S\u00ed, Aprobar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    ejecutarAprobacion();
                }
            });
        }

        function ejecutarAprobacion() {
            const guid = document.getElementById('hdnGuidOrdenPago').value;
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            f_loading();
            fetch('@Url.Action("Aprobar", "OrdenPagoAprobacion")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify({ guidOrdenPago: guid })
            })
            .then(response => response.json())
            .then(data => {
                f_remove_loading();
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Aprobado',
                        text: data.message,
                        confirmButtonColor: '#28a745'
                    }).then(() => {
                        window.location.href = '@Url.Action("Index", "OrdenPagoAprobacion")';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            })
            .catch(error => {
                f_remove_loading();
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error al procesar la aprobaci\u00f3n.',
                    confirmButtonColor: '#dc3545'
                });
            });
        }

        function rechazarOrden() {
            Swal.fire({
                icon: 'warning',
                title: 'Devolver Orden de Pago',
                html: '<p>\u00bfEst\u00e1 seguro que desea devolver esta orden de pago?</p>' +
                      '<div class="form-group text-left mt-3">' +
                      '<label class="font-weight-bold">Comentario <span class="text-danger">*</span></label>' +
                      '<textarea id="txtComentarioRechazo" class="form-control" rows="3" ' +
                      'placeholder="Ingrese el motivo del rechazo..." maxlength="500"></textarea>' +
                      '</div>',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'S\u00ed, Devolver',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const comentario = document.getElementById('txtComentarioRechazo').value.trim();
                    if (!comentario) {
                        Swal.showValidationMessage('Debe ingresar un comentario');
                        return false;
                    }
                    return comentario;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    ejecutarRechazo(result.value);
                }
            });
        }

        function ejecutarRechazo(comentario) {
            const guid = document.getElementById('hdnGuidOrdenPago').value;
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            f_loading();
            fetch('@Url.Action("Rechazar", "OrdenPagoAprobacion")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify({ guidOrdenPago: guid, comentario: comentario })
            })
            .then(response => response.json())
            .then(data => {
                f_remove_loading();
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Devuelto',
                        text: data.message,
                        confirmButtonColor: '#28a745'
                    }).then(() => {
                        window.location.href = '@Url.Action("Index", "OrdenPagoAprobacion")';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            })
            .catch(error => {
                f_remove_loading();
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error al procesar el rechazo.',
                    confirmButtonColor: '#dc3545'
                });
            });
        }
    </script>
}
